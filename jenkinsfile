pipeline {
    agent any

    environment {
        TF_VERSION = '1.9.5'
        ANSIBLE_VERSION = '2.16.11'
        SECRETS_PATH = '/var/lib/jenkins/secrets/secrets.tfvars'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/melda-20/Automation.git'
            }
        }

        stage('Terraform Init') {
            steps {
                sh '''
                cp $SECRETS_PATH ./secrets.tfvars
                terraform init
                '''
            }
        }

        stage('Terraform Plan') {
            steps {
                sh 'terraform plan -var-file=secrets.tfvars -out=tfplan'
            }
        }

        stage('Terraform Apply') {
            steps {
                sh 'terraform apply -var-file=secrets.tfvars -auto-approve'
            }
        }

        stage('Get Terraform Output') {
            steps {
                script {
                    VM_IP = sh(script: 'terraform output -raw vm_ip', returnStdout: true).trim()
                    echo "VM IP: ${VM_IP}"
                }
            }
        }

        stage('Run Ansible Playbook: apache_webserver') {
            steps {
                script {
                    // Haal de SSH private key op uit secrets.tfvars en sla deze op in een bestand
                    SSH_PRIVATE_KEY = sh(script: "grep 'ssh_private_key' secrets.tfvars | cut -d'=' -f2 | tr -d '\"'", returnStdout: true).trim()
                    
                    // Schrijf de private key naar een tijdelijk bestand
                    writeFile file: 'ssh_private_key.pem', text: SSH_PRIVATE_KEY
                    
                    // Maak het key-bestand leesbaar alleen voor de eigenaar
                    sh 'chmod 600 ssh_private_key.pem'
                    
                    // Voer het Ansible-playbook uit met de SSH private key
                    sh """
                    ansible-playbook -i ${VM_IP}, apache_webserver.yml \
                    --private-key ssh_private_key.pem \
                    -u student
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
